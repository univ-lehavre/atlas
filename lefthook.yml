# Lefthook configuration for Atlas
# Documentation: https://github.com/evilmartians/lefthook

commit-msg:
  commands:
    commitlint:
      run: pnpm commitlint --edit {1}

pre-commit:
  parallel: true
  commands:
    format:
      run: pnpm prettier --write --ignore-path .prettierignore {staged_files}
      stage_fixed: true
      glob: '*.{js,ts,svelte,json,yaml,yml,md,css,html}'

    cpd:
      run: pnpm cpd

    knip:
      run: pnpm knip

    test:
      run: pnpm test

    typecheck:
      run: pnpm typecheck

    # Run svelte-kit sync first to generate .svelte-kit/tsconfig.json needed by eslint-plugin-n
    lint:
      run: pnpm -F ecrin exec svelte-kit sync && pnpm eslint --fix {staged_files}
      stage_fixed: true
      glob: '*.{js,ts,svelte}'

pre-push:
  commands:
    check-branch:
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        if [ "$branch" = "main" ]; then
          echo "❌ Push direct sur main interdit. Utilisez une branche et une PR."
          exit 1
        fi
      priority: 1

    check-sync:
      run: |
        git fetch origin --quiet
        if ! git merge-base --is-ancestor origin/main HEAD 2>/dev/null; then
          echo "⚠️  Votre branche n'est pas à jour avec main."
          echo "   Exécutez: git fetch origin && git rebase origin/main"
        fi
      priority: 1

    check-audit:
      run: pnpm audit --audit-level=high
      priority: 2

    check-licenses:
      run: pnpm license:audit
      priority: 2

    check-lockfile:
      run: pnpm install --frozen-lockfile
      priority: 2
