---
# Cilium Ingress for ecrin application
# Uses Authelia forward-auth for protected routes
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ecrin-ingress
  namespace: ecrin
  annotations:
    # Cilium Ingress Controller
    kubernetes.io/ingress.class: cilium
    # Forward-auth to Authelia for protected routes
    # This annotation tells Cilium to check with Authelia before forwarding
spec:
  rules:
    - host: localhost
      http:
        paths:
          # Authelia endpoints (public - handles its own auth)
          - path: /authelia
            pathType: Prefix
            backend:
              service:
                name: authelia
                port:
                  number: 9091
          # Main application
          - path: /
            pathType: Prefix
            backend:
              service:
                name: ecrin
                port:
                  number: 3000
---
# Ingress for protected routes with forward-auth
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ecrin-protected-ingress
  namespace: ecrin
  annotations:
    kubernetes.io/ingress.class: cilium
    # Authelia forward-auth configuration
    nginx.ingress.kubernetes.io/auth-url: 'http://authelia.ecrin.svc.cluster.local:9091/api/authz/forward-auth'
    nginx.ingress.kubernetes.io/auth-signin: 'http://localhost:8080/authelia/?rd=$scheme://$host$request_uri'
    nginx.ingress.kubernetes.io/auth-response-headers: 'Remote-User,Remote-Email,Remote-Groups,Remote-Name'
spec:
  rules:
    - host: localhost
      http:
        paths:
          # Protected routes - require authentication
          - path: /dashboard
            pathType: Prefix
            backend:
              service:
                name: ecrin
                port:
                  number: 3000
          - path: /records
            pathType: Prefix
            backend:
              service:
                name: ecrin
                port:
                  number: 3000
          - path: /users
            pathType: Prefix
            backend:
              service:
                name: ecrin
                port:
                  number: 3000
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: ecrin
                port:
                  number: 3000
---
# CiliumEnvoyConfig for forward-auth (Cilium native way)
apiVersion: cilium.io/v2
kind: CiliumEnvoyConfig
metadata:
  name: authelia-forward-auth
  namespace: ecrin
spec:
  services:
    - name: ecrin
      namespace: ecrin
  backendServices:
    - name: authelia
      namespace: ecrin
      port:
        port: 9091
  resources:
    - '@type': type.googleapis.com/envoy.config.listener.v3.Listener
      name: ecrin-listener
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                '@type': type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ecrin
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: ecrin
                      domains: ['*']
                      routes:
                        # Public routes - no auth required
                        - match:
                            prefix: '/authelia'
                          route:
                            cluster: ecrin/authelia:9091
                        - match:
                            prefix: '/'
                            headers:
                              - name: ':path'
                                exact_match: '/'
                          route:
                            cluster: ecrin/ecrin:3000
                        - match:
                            prefix: '/about'
                          route:
                            cluster: ecrin/ecrin:3000
                        # Protected routes - require forward-auth
                        - match:
                            prefix: '/dashboard'
                          route:
                            cluster: ecrin/ecrin:3000
                        - match:
                            prefix: '/records'
                          route:
                            cluster: ecrin/ecrin:3000
                        - match:
                            prefix: '/users'
                          route:
                            cluster: ecrin/ecrin:3000
                        - match:
                            prefix: '/api'
                          route:
                            cluster: ecrin/ecrin:3000
                http_filters:
                  # External authorization filter for protected routes
                  - name: envoy.filters.http.ext_authz
                    typed_config:
                      '@type': type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                      http_service:
                        server_uri:
                          uri: authelia.ecrin.svc.cluster.local:9091
                          cluster: ecrin/authelia:9091
                          timeout: 5s
                        path_prefix: /api/authz/forward-auth
                        authorization_request:
                          allowed_headers:
                            patterns:
                              - exact: cookie
                              - exact: authorization
                        authorization_response:
                          allowed_upstream_headers:
                            patterns:
                              - exact: remote-user
                              - exact: remote-email
                              - exact: remote-groups
                              - exact: remote-name
                      failure_mode_allow: false
                  - name: envoy.filters.http.router
                    typed_config:
                      '@type': type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
