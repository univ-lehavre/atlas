apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-config
  namespace: ecrin
data:
  configuration.yml: |
    ---
    # Authelia Configuration for ECRIN Zero Trust
    # https://www.authelia.com/configuration/

    theme: auto

    server:
      address: 'tcp://0.0.0.0:9091/'
      buffers:
        read: 4096
        write: 4096
      timeouts:
        read: 6s
        write: 6s
        idle: 30s

    log:
      level: info
      format: json

    totp:
      disable: true  # We use magic links, not TOTP

    webauthn:
      disable: true  # Disabled for dev

    # Identity validation for passwordless (magic links)
    identity_validation:
      reset_password:
        jwt_lifespan: 5m
        jwt_algorithm: HS256

    # Authentication backend - file-based for dev
    authentication_backend:
      password_reset:
        disable: false
      file:
        path: /users/users.yml
        watch: true
        search:
          email: true
          case_insensitive: true
        password:
          algorithm: argon2
          argon2:
            variant: argon2id
            iterations: 3
            memory: 65536
            parallelism: 4
            key_length: 32
            salt_length: 16

    # Session configuration
    session:
      name: authelia_session
      same_site: lax
      expiration: 1h
      inactivity: 15m
      remember_me: 1M
      cookies:
        - domain: 'localhost'
          authelia_url: 'http://localhost:8080/authelia'
          default_redirection_url: 'http://localhost:8080/'

    # Storage - SQLite for dev (use PostgreSQL in prod)
    storage:
      local:
        path: /config/db.sqlite3

    # Notifier - MailHog for dev
    notifier:
      disable_startup_check: false
      smtp:
        address: 'smtp://mailhog:1025'
        sender: 'ECRIN Auth <auth@ecrin.local>'
        disable_require_tls: true
        disable_starttls: true
        disable_html_emails: false

    # Access control policies
    access_control:
      default_policy: bypass

      rules:
        # Authelia endpoints are always accessible
        - domain: 'localhost'
          resources:
            - '^/authelia.*$'
          policy: bypass

        # Public routes
        - domain: 'localhost'
          resources:
            - '^/$'
            - '^/about.*$'
            - '^/favicon.ico$'
            - '^/_app/.*$'
          policy: bypass

        # Protected routes - require authentication
        - domain: 'localhost'
          resources:
            - '^/dashboard.*$'
            - '^/records.*$'
            - '^/users.*$'
            - '^/api.*$'
          policy: one_factor
          subject:
            - 'group:allowed-domain'
            - 'group:admin'
            - 'group:researcher'
            - 'group:viewer'

    # Regulation - brute force protection
    regulation:
      max_retries: 3
      find_time: 2m
      ban_time: 5m

    # Password policy
    password_policy:
      standard:
        enabled: false  # Using magic links
      zxcvbn:
        enabled: false
