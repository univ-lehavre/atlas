apiVersion: v1
kind: ConfigMap
metadata:
  name: opa-policies
  namespace: ecrin
data:
  authz.rego: |
    # ECRIN Authorization Policy
    # RBAC/ABAC policy engine for Zero Trust access control

    package ecrin.authz

    import future.keywords.if
    import future.keywords.in

    # Default deny - Zero Trust principle
    default allow := false

    # Admin role - full access
    allow if {
        "admin" in input.user.groups
    }

    # Researcher role - can read all, write own resources
    allow if {
        "researcher" in input.user.groups
        input.action == "read"
    }

    allow if {
        "researcher" in input.user.groups
        input.action == "write"
        input.resource.owner == input.user.email
    }

    allow if {
        "researcher" in input.user.groups
        input.action == "write"
        input.resource.type == "record"
        not input.resource.owner
    }

    # Viewer role - read only
    allow if {
        "viewer" in input.user.groups
        input.action == "read"
    }

    # Domain-based access for allowed-domain group
    allow if {
        "allowed-domain" in input.user.groups
        input.action == "read"
    }

    # Deny delete for non-admin
    deny if {
        input.action == "delete"
        not "admin" in input.user.groups
    }

    # Final decision
    final_allow := allow if {
        not deny
    }

  context.rego: |
    # ECRIN Context Policy
    # Risk scoring and contextual access control

    package ecrin.context

    import future.keywords.if
    import future.keywords.in

    default risk_score := 0.5

    trusted_networks := [
        "10.0.0.0/8",
        "172.16.0.0/12",
        "192.168.0.0/16",
        "127.0.0.0/8"
    ]

    risk_score := 0.1 if {
        some network in trusted_networks
        net.cidr_contains(network, input.context.ip)
    }

    final_risk_score := risk_score

    high_risk if {
        final_risk_score > 0.7
    }

    device_trusted if {
        true
    }
